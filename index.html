<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Drag & Drop Payload Builder</title>
  <style>
    :root{
      --bg:#0f172a; /* slate-900 */
      --panel:#111827; /* gray-900 */
      --muted:#1f2937; /* gray-800 */
      --card:#0b1220; /* dark */
      --text:#e5e7eb; /* gray-200 */
      --sub:#9ca3af; /* gray-400 */
      --accent:#22d3ee; /* cyan-400 */
      --accent-2:#60a5fa; /* blue-400 */
      --ok:#34d399; /* green-400 */
      --warn:#f59e0b; /* amber-500 */
      --err:#f87171; /* red-400 */
      --border:#233047;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:linear-gradient(180deg,#0b1020,#0f172a); color:var(--text); font:14px/1.4 system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
    }
    header{
      display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid var(--border); background:rgba(17,24,39,.7); backdrop-filter:saturate(1.2) blur(6px); position:sticky; top:0; z-index:10;
    }
    header h1{font-size:16px; margin:0; letter-spacing:.4px}
    .layout{display:grid; grid-template-columns:280px 1fr 420px; gap:12px; height:calc(100% - 54px); padding:12px}
    .panel{background:var(--panel); border:1px solid var(--border); border-radius:14px; overflow:auto}

    /* Palette */
    .palette{padding:12px}
    .group{margin-bottom:16px}
    .group h3{margin:10px 6px; font-size:12px; color:var(--sub); text-transform:uppercase; letter-spacing:.12em}
    .tile{
      display:flex; align-items:center; gap:10px; padding:10px; margin:8px 6px; border:1px dashed #2a3a58; border-radius:10px; cursor:grab; user-select:none; background:linear-gradient(180deg,#0c1323,#0e1730);
    }
    .tile:hover{border-color:#3c4f77}
    .tile .badge{font-size:10px; color:#94a3b8; background:#0b1220; padding:2px 6px; border-radius:999px; border:1px solid #2a3a58}

    /* Canvas */
    .canvas{
      display:flex; flex-direction:column; padding:12px; gap:12px;
    }
    .dropzone{
      flex:1; min-height:240px; border:2px dashed #233047; border-radius:14px; padding:12px; display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:12px; align-content:flex-start;
    }
    .dropzone.dragover{border-color:var(--accent)}
    .hint{color:var(--sub); font-size:13px; padding:8px 4px}

    .card{
      background:linear-gradient(180deg,#0a111f,#0b1220); border:1px solid var(--border); border-radius:14px; padding:12px; display:flex; flex-direction:column; gap:8px;
    }
    .card header{position:unset; background:transparent; border:none; padding:0; display:flex; align-items:center; justify-content:space-between}
    .card h4{margin:0; font-size:13px}
    .card .sub{color:var(--sub); font-size:12px}
    .card .controls{display:flex; gap:8px}
    .btn{background:#0c1424; border:1px solid #2a3a58; color:var(--text); padding:6px 10px; border-radius:10px; cursor:pointer}
    .btn:hover{border-color:#3e5b8e}
    .btn.warn{border-color:#5a3b10; background:#1a1405; color:#fbbf24}
    .btn.danger{border-color:#5b2222; background:#1b0c0c; color:#fca5a5}
    .btn.primary{border-color:#175b68; background:#0a1720; color:#67e8f9}
    .row{display:grid; grid-template-columns:repeat(12,1fr); gap:8px}
    .col-12{grid-column:span 12}
    .col-6{grid-column:span 6}
    .col-4{grid-column:span 4}
    .col-3{grid-column:span 3}
    label{display:block; font-size:12px; color:#a5b4fc; margin-bottom:4px}
    input, select, textarea{width:100%; background:#0b1220; color:var(--text); border:1px solid #2a3a58; border-radius:10px; padding:8px}
    textarea{min-height:88px; resize:vertical}

    .kbar{display:flex; gap:8px; padding:8px}
    .json-panel{display:flex; flex-direction:column}
    .json-panel .out{flex:1; padding:10px; background:#0b1220; border-top:1px solid var(--border); font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; white-space:pre; overflow:auto}
    .status{padding:8px 10px; color:#e5e7eb; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center}
    .status .pill{font-size:11px; padding:2px 8px; border:1px solid #2a3a58; border-radius:999px; color:#93c5fd}

    .list{display:flex; flex-direction:column; gap:8px}
    .list .item{background:#0a1222; border:1px solid #223350; border-radius:10px; padding:8px}
    .item .item-row{display:grid; grid-template-columns:repeat(12,1fr); gap:6px}

    .ghost{opacity:.4}
  </style>
</head>
<body>
  <header>
    <h1>Cards → Editor → JSON</h1>
    <div style="display:flex; gap:8px; align-items:center">
      <span style="font-size:12px; color:var(--sub)">Schema: Suggestion</span>
    </div>
  </header>
  <div class="layout">
    <aside class="panel palette" id="palette">
      <div class="group">
        <h3>Root</h3>
        <div class="tile" draggable="true" data-card="root.type"><span class="badge">required</span> type</div>
        <div class="tile" draggable="true" data-card="root.title"><span class="badge">required</span> title</div>
        <div class="tile" draggable="true" data-card="root.summary">summary</div>
        <div class="tile" draggable="true" data-card="root.status">status</div>
        <div class="tile" draggable="true" data-card="root.priority">priority</div>
        <div class="tile" draggable="true" data-card="root.published_at">published_at</div>
        <div class="tile" draggable="true" data-card="root.partner_ids">partner_ids</div>
      </div>
      <div class="group">
        <h3>Payload comune</h3>
        <div class="tile" draggable="true" data-card="payload.tags">tags</div>
        <div class="tile" draggable="true" data-card="payload.seo">seo</div>
        <div class="tile" draggable="true" data-card="payload.attachments">attachments</div>
        <div class="tile" draggable="true" data-card="payload.links">links</div>
        <div class="tile" draggable="true" data-card="payload.contacts">contacts</div>
        <div class="tile" draggable="true" data-card="payload.media-simple">media (image/video)</div>
        <div class="tile" draggable="true" data-card="payload.notes_md">notes_md</div>
      </div>
      <div class="group">
        <h3>Event payload</h3>
        <div class="tile" draggable="true" data-card="event.when">start/end/timezone</div>
        <div class="tile" draggable="true" data-card="event.venue">venue</div>
        <div class="tile" draggable="true" data-card="event.flags">online / livestream / registration</div>
        <div class="tile" draggable="true" data-card="event.agenda">agenda</div>
        <div class="tile" draggable="true" data-card="event.speakers">speakers</div>
        <div class="tile" draggable="true" data-card="event.tickets">tickets</div>
      </div>
      <div class="group">
        <h3>Export</h3>
        <div class="tile" draggable="false" id="quick-min"><span class="badge">preset</span> minimo obbligatorio</div>
      </div>
    </aside>

    <main class="panel canvas">
      <div class="hint">Trascina le card dal pannello sinistro qui sotto. I campi duplicati singlet vengono riutilizzati.</div>
      <section class="dropzone" id="dropzone"></section>
    </main>

    <section class="panel json-panel">
      <div class="status">
        <span>Output JSON</span>
        <span id="status-pill" class="pill">idle</span>
      </div>
      <div class="kbar">
        <button class="btn primary" id="build">Build JSON</button>
        <button class="btn" id="copy">Copia</button>
        <button class="btn" id="download">Download</button>
        <button class="btn warn" id="clear">Reset editor</button>
      </div>
      <pre class="out" id="out">{}</pre>
    </section>
  </div>

<script>
  const el = sel => document.querySelector(sel);
  const create = (tag, cls) => { const n=document.createElement(tag); if(cls) n.className=cls; return n; };
  const setPill = (t,c) => { const p=el('#status-pill'); p.textContent=t; };
  const ensureSeconds = (v) => {
    if(!v) return null; // input type datetime-local may yield "YYYY-MM-DDTHH:mm" or with seconds
    // Normalize to YYYY-MM-DDTHH:mm:ss
    if(/\d{2}:\d{2}:\d{2}$/.test(v)) return v;
    if(/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(v)) return v+':00';
    return v; // leave as-is if unknown
  };
  const stripSeconds = (v) => {
    if(!v) return null;
    const m = v.match(/^(\d{4}-\d{2}-\d{2}T\d{2}:\d{2})/);
    return m? m[1] : v;
  };
  function deepSet(obj, path, value){
    const parts = Array.isArray(path) ? path : path.split('.');
    let cur = obj;
    for(let i=0;i<parts.length-1;i++){
      const k=parts[i];
      if(!(k in cur) || typeof cur[k] !== 'object' || cur[k]===null) cur[k]={};
      cur = cur[k];
    }
    cur[parts[parts.length-1]] = value;
  }

  const DROPZONE = el('#dropzone');

  const SINGLETON = new Set([
    'root.type','root.title','root.summary','root.status','root.priority','root.published_at','root.partner_ids',
    'payload.tags','payload.seo','payload.attachments','payload.links','payload.contacts','payload.media-simple','payload.notes_md',
    'event.when','event.venue','event.flags','event.agenda','event.speakers','event.tickets'
  ]);

  const CARD_DEFS = {
    'root.type': {
      title:'type', singleton:true, build(container){
        const w=create('div','row');
        const c=create('div','col-12'); w.appendChild(c);
        const label=create('label'); label.textContent='type'; c.appendChild(label);
        const sel=create('select'); sel.name='type'; ['event','collaboration','announcement','news'].forEach(v=>{ const o=create('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
        c.appendChild(sel);
        return w;
      }, serialize(container, acc){ acc.type = container.querySelector('select[name="type"]').value; }
    },
    'root.title': {
      title:'title', singleton:true, build(){
        const w=create('div','row');
        const c=create('div','col-12'); w.appendChild(c);
        const l=create('label'); l.textContent='title'; c.appendChild(l);
        const i=create('input'); i.type='text'; i.name='title'; i.maxLength=140; c.appendChild(i);
        return w;
      }, serialize(container, acc){ acc.title = container.querySelector('input[name="title"]').value.trim(); }
    },
    'root.summary': {
      title:'summary', singleton:true, build(){
        const w=create('div','row');
        const c=create('div','col-12'); w.appendChild(c);
        const l=create('label'); l.textContent='summary (max 300)'; c.appendChild(l);
        const t=create('textarea'); t.maxLength=300; t.name='summary'; c.appendChild(t);
        return w;
      }, serialize(container, acc){ const v=container.querySelector('textarea[name="summary"]').value.trim(); if(v) acc.summary=v; }
    },
    'root.status': { title:'status', singleton:true, build(){
      const w=create('div','row'); const c=create('div','col-6'); const d=create('div','col-6'); w.append(c,d);
      let l=create('label'); l.textContent='status'; c.appendChild(l);
      const s=create('select'); s.name='status'; ['draft','approved','published','archived'].forEach(v=>{ const o=create('option'); o.value=v; o.textContent=v; s.appendChild(o); }); c.appendChild(s);
      l=create('label'); l.textContent='priority (-10..10)'; d.appendChild(l);
      const n=create('input'); n.type='number'; n.name='priority'; n.min=-10; n.max=10; n.value=0; d.appendChild(n);
      return w;
    }, serialize(container, acc){
      acc.status = container.querySelector('select[name="status"]').value;
      acc.priority = Number(container.querySelector('input[name="priority"]').value||0);
    }},
    'root.published_at': { title:'published_at', singleton:true, build(){
      const w=create('div','row'); const c=create('div','col-12'); w.appendChild(c);
      const l=create('label'); l.textContent='published_at (YYYY-MM-DDTHH:mm)'; c.appendChild(l);
      const i=create('input'); i.type='datetime-local'; i.name='published_at'; c.appendChild(i);
      return w;
    }, serialize(container, acc){ const v=container.querySelector('input[name="published_at"]').value; if(v) acc.published_at = stripSeconds(v); }},
    'root.partner_ids': { title:'partner_ids', singleton:true, build(){
      const w=create('div','list');
      const ctrl=create('div');
      const add=create('button'); add.textContent='+ id'; add.className='btn';
      ctrl.appendChild(add); w.appendChild(ctrl);
      const list=create('div'); w.appendChild(list);
      add.addEventListener('click',()=>{
        const itm=create('div','item');
        const r=create('div','item-row'); itm.appendChild(r);
        const c1=create('div','col-9'); const c2=create('div','col-3'); r.append(c1,c2);
        let l=create('label'); l.textContent='id ≥ 1'; c1.appendChild(l);
        const n=create('input'); n.type='number'; n.min=1; n.name='pid'; c1.appendChild(n);
        const rm=create('button'); rm.textContent='rimuovi'; rm.className='btn danger'; rm.onclick=()=>itm.remove(); c2.appendChild(rm);
        list.appendChild(itm);
      });
      return w;
    }, serialize(container, acc){ const ids=[...container.querySelectorAll('input[name="pid"]')].map(i=>Number(i.value)).filter(v=>Number.isFinite(v)&&v>=1); if(ids.length) acc.partner_ids=[...new Set(ids)]; }},

    'payload.tags': { title:'payload.tags', singleton:true, build(){
      const w=create('div','row'); const c=create('div','col-12'); w.appendChild(c);
      const l=create('label'); l.textContent='tags (string)'; c.appendChild(l);
      const input=create('input'); input.placeholder='invio per aggiungere';
      const chips=create('div'); chips.className='list'; chips.style.flexDirection='row'; chips.style.flexWrap='wrap'; chips.style.gap='6px';
      c.append(input,chips);
      input.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); const v=input.value.trim(); if(!v) return; const chip=create('span'); chip.textContent=v; chip.className='btn'; chip.style.borderRadius='999px'; chip.dataset.val=v; chip.onclick=()=>chip.remove(); chips.appendChild(chip); input.value=''; }});
      return w;
    }, serialize(container, acc){ const vals=[...container.querySelectorAll('[data-val]')].map(x=>x.dataset.val); if(vals.length){ if(!acc.payload) acc.payload={}; acc.payload.tags=[...new Set(vals)]; }}},

    'payload.seo': { title:'payload.seo', singleton:true, build(){
      const w=create('div','row');
      const a=create('div','col-6'); const b=create('div','col-6'); const c=create('div','col-12'); w.append(a,b,c);
      let l=create('label'); l.textContent='slug (3..80)'; a.appendChild(l);
      const slug=create('input'); slug.name='slug'; slug.minLength=3; slug.maxLength=80; a.appendChild(slug);
      l=create('label'); l.textContent='image URL'; b.appendChild(l);
      const img=create('input'); img.type='url'; img.name='image'; b.appendChild(img);
      l=create('label'); l.textContent='keywords (invio per aggiungere)'; c.appendChild(l);
      const kw=create('input'); kw.placeholder='keyword'; c.appendChild(kw);
      const list=create('div'); list.className='list'; list.style.flexDirection='row'; list.style.flexWrap='wrap'; list.style.gap='6px'; c.appendChild(list);
      kw.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); const v=kw.value.trim(); if(!v) return; const chip=create('span'); chip.className='btn'; chip.dataset.val=v; chip.textContent=v; chip.onclick=()=>chip.remove(); list.appendChild(chip); kw.value=''; }});
      return w;
    }, serialize(container, acc){ const slug=container.querySelector('input[name="slug"]').value.trim(); const image=container.querySelector('input[name="image"]').value.trim(); const kws=[...container.querySelectorAll('[data-val]')].map(x=>x.dataset.val);
      if(!acc.payload) acc.payload={}; const seo={}; if(slug) seo.slug=slug; if(kws.length) seo.keywords=[...new Set(kws)]; if(image) seo.image=image; if(Object.keys(seo).length) acc.payload.seo=seo; }},

    'payload.attachments': { title:'payload.attachments', singleton:true, build(){ return buildArrayOfObject('attachments', [
      {label:'label', type:'text', name:'label', required:true},
      {label:'url', type:'url', name:'url', required:true},
      {label:'type', type:'select', name:'type', options:['pdf','image','doc','sheet','other']}
    ]); }, serialize(container, acc){ const arr = serializeArray(container); if(arr.length){ if(!acc.payload) acc.payload={}; acc.payload.attachments=arr; }}},

    'payload.links': { title:'payload.links', singleton:true, build(){ return buildArrayOfObject('links', [
      {label:'label', type:'text', name:'label', required:true},
      {label:'url', type:'url', name:'url', required:true},
      {label:'rel', type:'text', name:'rel'},
      {label:'external', type:'checkbox', name:'external'}
    ]); }, serialize(container, acc){ const arr = serializeArray(container); if(arr.length){ if(!acc.payload) acc.payload={}; acc.payload.links=arr; }}},

    'payload.contacts': { title:'payload.contacts', singleton:true, build(){ return buildArrayOfObject('contacts', [
      {label:'name', type:'text', name:'name', required:true},
      {label:'role', type:'text', name:'role'},
      {label:'email', type:'text', name:'email'},
      {label:'url', type:'url', name:'url'},
      {label:'avatar_url', type:'url', name:'avatar_url'}
    ]); }, serialize(container, acc){ const arr = serializeArray(container); if(arr.length){ if(!acc.payload) acc.payload={}; acc.payload.contacts=arr; }}},

    'payload.media-simple': { title:'payload.media (image/video)', singleton:true, build(){ return buildArrayOfObject('media', [
      {label:'type', type:'select', name:'type', required:true, options:['image','video']},
      {label:'url', type:'url', name:'url', required:true},
      {label:'caption', type:'text', name:'caption'},
      {label:'alt/provider', type:'text', name:'alt_or_provider', hint:'alt (image) / provider (video)'}
    ], {transform:(obj)=>{ if(obj.type==='image'){ const {type,url,caption,alt_or_provider}=obj; const out={type,url}; if(caption) out.caption=caption; if(alt_or_provider) out.alt=alt_or_provider; return out; } else { const {type,url,caption,alt_or_provider}=obj; const out={type,url}; if(caption) out.caption=caption; if(alt_or_provider) out.provider=alt_or_provider; return out; } }}); }, serialize(container, acc){ const arr = serializeArray(container); if(arr.length){ if(!acc.payload) acc.payload={}; acc.payload.media=arr; }}},

    'payload.notes_md': { title:'payload.notes_md', singleton:true, build(){
      const w=create('div','row'); const c=create('div','col-12'); w.appendChild(c);
      const l=create('label'); l.textContent='notes_md'; c.appendChild(l);
      const t=create('textarea'); t.name='notes_md'; c.appendChild(t);
      return w;
    }, serialize(container, acc){ const v=container.querySelector('textarea[name="notes_md"]').value.trim(); if(v){ if(!acc.payload) acc.payload={}; acc.payload.notes_md=v; } }},

    // Event payload
    'event.when': { title:'event: start/end/timezone', singleton:true, build(){
      const w=create('div','row');
      const a=create('div','col-4'); const b=create('div','col-4'); const c=create('div','col-4'); w.append(a,b,c);
      let l=create('label'); l.textContent='start_at (local)'; a.appendChild(l); const s=create('input'); s.type='datetime-local'; s.step=1; s.name='start_at'; a.appendChild(s);
      l=create('label'); l.textContent='end_at (local)'; b.appendChild(l); const e=create('input'); e.type='datetime-local'; e.step=1; e.name='end_at'; b.appendChild(e);
      l=create('label'); l.textContent='timezone (IANA)'; c.appendChild(l); const tz=create('input'); tz.type='text'; tz.name='timezone'; tz.placeholder='Europe/Rome'; c.appendChild(tz);
      return w;
    }, serialize(container, acc){ const start=ensureSeconds(container.querySelector('input[name="start_at"]').value); const end=ensureSeconds(container.querySelector('input[name="end_at"]').value); const tz=container.querySelector('input[name="timezone"]').value.trim(); if(!acc.payload) acc.payload={}; if(start) acc.payload.start_at=start; if(end) acc.payload.end_at=end; if(tz) acc.payload.timezone=tz; }},

    'event.venue': { title:'event: venue', singleton:true, build(){
      const w=create('div','row');
      const a=create('div','col-6'); const b=create('div','col-6'); const c=create('div','col-12'); const d=create('div','col-3'); const e=create('div','col-3'); const f=create('div','col-3'); const g=create('div','col-3');
      w.append(a,b,c,d,e,f,g);
      let l=create('label'); l.textContent='name'; a.appendChild(l); const name=create('input'); name.name='name'; a.appendChild(name);
      l=create('label'); l.textContent='address'; b.appendChild(l); const addr=create('input'); addr.name='address'; b.appendChild(addr);
      l=create('label'); l.textContent='map_url'; c.appendChild(l); const map=create('input'); map.type='url'; map.name='map_url'; c.appendChild(map);
      l=create('label'); l.textContent='lat (-90..90)'; d.appendChild(l); const lat=create('input'); lat.type='number'; lat.step='any'; lat.min='-90'; lat.max='90'; lat.name='lat'; d.appendChild(lat);
      l=create('label'); l.textContent='lon (-180..180)'; e.appendChild(l); const lon=create('input'); lon.type='number'; lon.step='any'; lon.min='-180'; lon.max='180'; lon.name='lon'; e.appendChild(lon);
      l=create('label'); l.textContent='room'; f.appendChild(l); const room=create('input'); room.name='room'; f.appendChild(room);
      const note=create('div','sub col-12'); note.textContent='name richiesto nello schema'; w.appendChild(note);
      return w;
    }, serialize(container, acc){ const out={}; ['name','address','map_url','room'].forEach(k=>{ const v=container.querySelector(`[name="${k}"]`).value.trim(); if(v) out[k]=v; });
      const lat=container.querySelector('[name="lat"]').value; const lon=container.querySelector('[name="lon"]').value; if(lat!=='') out.lat=Number(lat); if(lon!=='') out.lon=Number(lon);
      if(Object.keys(out).length){ if(!acc.payload) acc.payload={}; acc.payload.venue=out; }
    }},

    'event.flags': { title:'event: online / livestream / registration', singleton:true, build(){
      const w=create('div','row');
      const a=create('div','col-3'); const b=create('div','col-9'); w.append(a,b);
      let l=create('label'); l.textContent='online'; a.appendChild(l); const on=create('select'); on.name='online'; ['','true','false'].forEach(v=>{ const o=create('option'); o.value=v; o.textContent=v; on.appendChild(o); }); a.appendChild(on);
      const box=create('div','col-12'); box.style.gridColumn='span 12'; box.style.marginTop='4px'; w.appendChild(box);
      // livestream
      const ls=create('div','item'); const r1=create('div','item-row'); ls.appendChild(r1);
      let c1=create('div','col-3'); let c2=create('div','col-4'); let c3=create('div','col-5'); r1.append(c1,c2,c3);
      l=create('label'); l.textContent='livestream.enabled'; c1.appendChild(l); const lsen=create('select'); lsen.name='ls_enabled'; ['','true','false'].forEach(v=>{ const o=create('option'); o.value=v; o.textContent=v; lsen.appendChild(o); }); c1.appendChild(lsen);
      l=create('label'); l.textContent='platform'; c2.appendChild(l); const lsp=create('input'); lsp.name='ls_platform'; c2.appendChild(lsp);
      l=create('label'); l.textContent='url'; c3.appendChild(l); const lsu=create('input'); lsu.type='url'; lsu.name='ls_url'; c3.appendChild(lsu);
      box.appendChild(ls);
      // registration
      const rg=create('div','item'); const r2=create('div','item-row'); rg.appendChild(r2);
      c1=create('div','col-3'); c2=create('div','col-5'); c3=create('div','col-4'); r2.append(c1,c2,c3);
      l=create('label'); l.textContent='registration.required'; c1.appendChild(l); const rr=create('select'); rr.name='reg_req'; ['','true','false'].forEach(v=>{ const o=create('option'); o.value=v; o.textContent=v; rr.appendChild(o); }); c1.appendChild(rr);
      l=create('label'); l.textContent='url'; c2.appendChild(l); const ru=create('input'); ru.type='url'; ru.name='reg_url'; c2.appendChild(ru);
      l=create('label'); l.textContent='deadline (local)'; c3.appendChild(l); const rd=create('input'); rd.type='datetime-local'; rd.step=1; rd.name='reg_deadline'; c3.appendChild(rd);
      return w;
    }, serialize(container, acc){ if(!acc.payload) acc.payload={};
      const online=container.querySelector('select[name="online"]').value; if(online) acc.payload.online = online==='true';
      const lsen=container.querySelector('select[name="ls_enabled"]').value; const platform=container.querySelector('input[name="ls_platform"]').value.trim(); const url=container.querySelector('input[name="ls_url"]').value.trim();
      const ls={}; if(lsen) ls.enabled = lsen==='true'; if(platform) ls.platform=platform; if(url) ls.url=url; if(Object.keys(ls).length) acc.payload.livestream = ls;
      const reg={}; const req=container.querySelector('select[name="reg_req"]').value; const rurl=container.querySelector('input[name="reg_url"]').value.trim(); const rdl=container.querySelector('input[name="reg_deadline"]').value; if(req) reg.required=req==='true'; if(rurl) reg.url=rurl; if(rdl) reg.deadline=ensureSeconds(rdl); if(Object.keys(reg).length) acc.payload.registration=reg;
    }},

    'event.agenda': { title:'event: agenda', singleton:true, build(){
      return buildArrayOfObject('agenda', [
        {label:'time (HH:MM)', type:'text', name:'time', placeholder:'09:30'},
        {label:'title', type:'text', name:'title'},
        {label:'speakers (invio per aggiungere)', type:'chips', name:'speakers'}
      ], {transform:(obj)=>{ const out={}; if(obj.time) out.time=obj.time; if(obj.title) out.title=obj.title; if(obj.speakers && obj.speakers.length) out.speakers=obj.speakers; return out; }});
    }, serialize(container, acc){ const arr=serializeArray(container); if(arr.length){ if(!acc.payload) acc.payload={}; acc.payload.agenda=arr; }}},

    'event.speakers': { title:'event: speakers', singleton:true, build(){
      return buildArrayOfObject('speakers', [
        {label:'name', type:'text', name:'name'},
        {label:'affiliation', type:'text', name:'affiliation'},
        {label:'bio', type:'textarea', name:'bio'},
        {label:'avatar_url', type:'url', name:'avatar_url'}
      ]);
    }, serialize(container, acc){ const arr=serializeArray(container); if(arr.length){ if(!acc.payload) acc.payload={}; acc.payload.speakers=arr; }}},

    'event.tickets': { title:'event: tickets', singleton:true, build(){
      const w=create('div','row');
      const a=create('div','col-3'); const b=create('div','col-3'); const c=create('div','col-3'); const d=create('div','col-3'); w.append(a,b,c,d);
      let l=create('label'); l.textContent='free'; a.appendChild(l); const fr=create('select'); fr.name='free'; ['','true','false'].forEach(v=>{ const o=create('option'); o.value=v; o.textContent=v; fr.appendChild(o); }); a.appendChild(fr);
      l=create('label'); l.textContent='capacity'; b.appendChild(l); const cap=create('input'); cap.type='number'; cap.min=0; cap.name='capacity'; b.appendChild(cap);
      l=create('label'); l.textContent='sold'; c.appendChild(l); const sold=create('input'); sold.type='number'; sold.min=0; sold.name='sold'; c.appendChild(sold);
      l=create('label'); l.textContent='price_eur'; d.appendChild(l); const pr=create('input'); pr.type='number'; pr.min=0; pr.step='any'; pr.name='price_eur'; d.appendChild(pr);
      return w;
    }, serialize(container, acc){ const out={}; const fr=container.querySelector('select[name="free"]').value; if(fr) out.free = fr==='true'; const cap=container.querySelector('input[name="capacity"]').value; if(cap!=='') out.capacity=Number(cap); const s=container.querySelector('input[name="sold"]').value; if(s!=='') out.sold=Number(s); const p=container.querySelector('input[name="price_eur"]').value; if(p!=='') out.price_eur=Number(p); if(Object.keys(out).length){ if(!acc.payload) acc.payload={}; acc.payload.tickets=out; }}}
  };

  // Helpers for array-of-object cards
  function buildArrayOfObject(title, fields, opts={}){
    const wrap=create('div','list');
    const ctrl=create('div');
    const add=create('button'); add.textContent='+ add'; add.className='btn'; ctrl.appendChild(add);
    wrap.appendChild(ctrl);
    const list=create('div'); wrap.appendChild(list);

    add.addEventListener('click',()=>{
      const item=create('div','item'); const row=create('div','item-row'); item.appendChild(row);
      fields.forEach(f=>{
        const col=create('div', f.type==='textarea' ? 'col-12' : 'col-4');
        const lab=create('label'); lab.textContent=f.label; col.appendChild(lab);
        let inp;
        switch(f.type){
          case 'text': case 'url': case 'number':
            inp=create('input'); inp.type=f.type==='number'?'number':(f.type==='url'?'url':'text'); break;
          case 'select':
            inp=create('select'); (f.options||[]).forEach(v=>{ const o=create('option'); o.value=v; o.textContent=v; inp.appendChild(o); }); break;
          case 'checkbox':
            inp=create('input'); inp.type='checkbox'; break;
          case 'textarea':
            inp=create('textarea'); break;
          case 'chips':
            inp=create('div');
            const input=create('input'); input.placeholder='valore';
            const chips=create('div'); chips.className='list'; chips.style.flexDirection='row'; chips.style.flexWrap='wrap'; chips.style.gap='6px';
            input.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); const v=input.value.trim(); if(!v) return; const chip=create('span'); chip.className='btn'; chip.dataset.val=v; chip.textContent=v; chip.onclick=()=>chip.remove(); chips.appendChild(chip); input.value=''; }});
            inp.append(input,chips);
            break;
        }
        inp.name=f.name;
        if(f.placeholder) inp.placeholder=f.placeholder;
        col.appendChild(inp);
        row.appendChild(col);
      });
      const actions=create('div','item-row');
      const rmCol=create('div','col-12'); const rmBtn=create('button'); rmBtn.textContent='rimuovi'; rmBtn.className='btn danger'; rmBtn.onclick=()=>item.remove(); rmCol.appendChild(rmBtn); actions.appendChild(rmCol); item.appendChild(actions);
      list.appendChild(item);
    });
    return wrap;
  }
  function serializeArray(container){
    const out=[];
    [...container.querySelectorAll('.list > div .item')].forEach(item=>{
      const obj={};
      const inputs=[...item.querySelectorAll('input, select, textarea')];
      const chipsScopes=[...item.querySelectorAll('.list')];
      let skipEmpty=true;
      inputs.forEach(inp=>{
        const name=inp.name; if(!name) return;
        if(inp.type==='checkbox'){ obj[name]=inp.checked; if(inp.checked) skipEmpty=false; return; }
        if(inp.type==='number'){ if(inp.value!==''){ obj[name]= Number(inp.value); skipEmpty=false; } return; }
        if(inp.type==='datetime-local'){ const v=inp.value; if(v){ obj[name]=ensureSeconds(v); skipEmpty=false; } return; }
        if(inp.tagName==='TEXTAREA' || inp.tagName==='SELECT' || inp.type==='text' || inp.type==='url'){
          const v=inp.value.trim(); if(v){ obj[name]=v; skipEmpty=false; }
        }
      });
      // chips fields
      chipsScopes.forEach(scope=>{
        const key = scope.previousSibling && scope.previousSibling.previousSibling && scope.previousSibling.previousSibling.name || null;
        const chips=[...scope.querySelectorAll('[data-val]')].map(x=>x.dataset.val);
        if(chips.length){ obj['speakers'] = chips; skipEmpty=false; }
      });
      if(Object.keys(obj).length && !skipEmpty){ out.push(objTransform(obj, container)); }
    });
    return out;
  }
  function objTransform(obj, container){
    const defKey = container.closest('.card')?.dataset.def;
    const def = CARD_DEFS[defKey];
    if(def && def.title && def.title.includes('media') && defKey==='payload.media-simple'){
      const tr = (o)=>{ if(o.type==='image'){ const out={type:'image', url:o.url}; if(o.caption) out.caption=o.caption; if(o.alt_or_provider) out.alt=o.alt_or_provider; return out; } else { const out={type:'video', url:o.url}; if(o.caption) out.caption=o.caption; if(o.alt_or_provider) out.provider=o.alt_or_provider; return out; } };
      return tr(obj);
    }
    return obj;
  }

  // Drag & drop
  let dragKey=null; let dragGhost=null;
  document.querySelectorAll('.tile[draggable="true"]').forEach(t=>{
    t.addEventListener('dragstart',e=>{ dragKey=t.dataset.card; e.dataTransfer.setData('text/plain', dragKey); dragKey=t.dataset.card; dragGhost=t.cloneNode(true); dragGhost.classList.add('ghost'); document.body.appendChild(dragGhost); e.dataTransfer.setDragImage(dragGhost, 10, 10); });
    t.addEventListener('dragend',()=>{ if(dragGhost) dragGhost.remove(); dragGhost=null; dragKey=null; });
  });
  DROPZONE.addEventListener('dragover',e=>{ e.preventDefault(); DROPZONE.classList.add('dragover'); });
  DROPZONE.addEventListener('dragleave',()=>DROPZONE.classList.remove('dragover'));
  DROPZONE.addEventListener('drop',e=>{
    e.preventDefault(); DROPZONE.classList.remove('dragover'); const key=e.dataTransfer.getData('text/plain')||dragKey; if(!key) return;
    if(SINGLETON.has(key)){
      const existing = DROPZONE.querySelector(`.card[data-def="${key}"]`);
      if(existing){ existing.scrollIntoView({behavior:'smooth', block:'center'}); existing.classList.add('pulse'); setTimeout(()=>existing.classList.remove('pulse'),600); return; }
    }
    addCard(key);
  });

  function addCard(key){
    const def = CARD_DEFS[key]; if(!def) return;
    const card=create('div','card'); card.dataset.def=key;
    const head=create('div'); head.className='card-head';
    const h=create('h4'); h.textContent=def.title; const sub=create('div','sub'); sub.textContent=(key.startsWith('root.')?'root':'payload');
    const ctr=create('div','controls');
    const up=create('button'); up.className='btn'; up.textContent='↑'; up.onclick=()=>{ const p=card.parentElement; const prev=card.previousElementSibling; if(prev) p.insertBefore(card, prev); };
    const down=create('button'); down.className='btn'; down.textContent='↓'; down.onclick=()=>{ const next=card.nextElementSibling; if(next) next.after(card); };
    const rm=create('button'); rm.className='btn danger'; rm.textContent='remove'; rm.onclick=()=>card.remove();
    ctr.append(up,down,rm);
    const header=create('div'); header.style.display='flex'; header.style.justifyContent='space-between'; header.style.alignItems='center';
    header.append(h,ctr);
    const body=create('div');
    body.appendChild(def.build(card));
    card.append(header,body);
    DROPZONE.appendChild(card);
  }

  // Quick preset: minimo obbligatorio
  el('#quick-min').addEventListener('click',()=>{
    ['root.type','root.title','root.status','root.priority'].forEach(addIfMissing);
  });
  function addIfMissing(k){ if(!DROPZONE.querySelector(`.card[data-def="${k}"]`)) addCard(k); }

  // Build JSON
  el('#build').addEventListener('click',()=>{
    const res={}; const cards=[...DROPZONE.querySelectorAll('.card')];
    // defaults
    let hasType=false, hasTitle=false;
    cards.forEach(card=>{
      const key=card.dataset.def; const def=CARD_DEFS[key]; if(!def) return; def.serialize(card, res);
      if(key==='root.type') hasType=true; if(key==='root.title') hasTitle=true;
    });
    // defaults for status/priority if absent
    if(!('status' in res)) res.status='draft';
    if(!('priority' in res)) res.priority=0;

    const errors=[];
    if(!hasType) errors.push('type mancante');
    if(!hasTitle) errors.push('title mancante');
    if('published_at' in res){ if(!/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(res.published_at)) errors.push('published_at non conforme YYYY-MM-DDTHH:mm'); }
    if(res.payload && ('start_at' in res.payload || 'end_at' in res.payload)){
      const chk = v=>/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}$/.test(v);
      if(res.payload.start_at && !chk(res.payload.start_at)) errors.push('start_at non conforme YYYY-MM-DDTHH:mm:ss');
      if(res.payload.end_at && !chk(res.payload.end_at)) errors.push('end_at non conforme YYYY-MM-DDTHH:mm:ss');
    }

    if(errors.length){ setPill('error'); el('#out').textContent = JSON.stringify({errors, draft:res}, null, 2); return; }

    setPill('ok'); el('#out').textContent = JSON.stringify(res, null, 2);
  });

  // Copy
  el('#copy').addEventListener('click',async()=>{
    const txt=el('#out').textContent; await navigator.clipboard.writeText(txt); setPill('copied'); setTimeout(()=>setPill('idle'),1000);
  });
  // Download
  el('#download').addEventListener('click',()=>{
    const blob=new Blob([el('#out').textContent||'{}'],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=create('a'); a.href=url; a.download='suggestion.payload.json'; a.click(); URL.revokeObjectURL(url);
  });
  // Clear
  el('#clear').addEventListener('click',()=>{ DROPZONE.innerHTML=''; el('#out').textContent='{}'; setPill('idle'); });

</script>
</body>
</html>
